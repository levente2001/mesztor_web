<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mesztor Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    html, body{height:100%}
    :root{
      --headerH: 64px;
      --sidebarW: 260px;
      --bg: #f6f8fb;
      --panel: #fff;
      --txt: #0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#2563eb;
      --primary-50:#e8f0ff;
      --success:#16a34a;
      --danger:#dc2626;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
      --radius: 14px;
    }

    *{box-sizing:border-box}
    body{opacity:0; transition:opacity .15s ease;}
    body.authed{opacity:1;}
    body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header.appbar{
      position:sticky; top:0; z-index:50;
      height:var(--headerH); display:flex; align-items:center; gap:12px;
      background:#fff; border-bottom:1px solid var(--border); padding:0 16px;
    }
    header .brand{font-weight:700}
    .badge{
      margin-left:auto; font-size:12px; padding:.35rem .6rem; border-radius:999px;
      border:1px solid var(--border); background:#fff;
    }
    .badge .dot{display:inline-block;width:.5rem;height:.5rem;border-radius:50%;margin-right:.35rem;background:#a3a3a3;vertical-align:middle}
    .badge.ok .dot{background:#16a34a}

    /* shell */
    .admin-shell{ display:block }
    .container{ padding: 18px }

    .drag-handle{ cursor: grab; user-select:none; }
    .drag-handle:active{ cursor: grabbing; }


    /* Sidebar (desktop: fix bal oldalt) */
    .sidebar{
      position:fixed; left:0; top:var(--headerH); bottom:0; width:var(--sidebarW);
      background:#fff; border-right:1px solid var(--border); box-shadow:var(--shadow);
      overflow:auto; z-index:30;
    }
    .side-head{padding:14px 14px 6px; font-weight:700; color:#111827}
    .side-nav{padding:8px}
    .side-link{
      display:flex; align-items:center; gap:.55rem; width:100%;
      margin-bottom:8px; padding:.65rem .8rem; border-radius:10px;
      background:#f8fafc; border:1px solid var(--border); cursor:pointer;
    }
    .side-link.active{background:var(--primary); color:#fff; border-color:var(--primary)}
    .side-link .emoji{width:1.2rem;text-align:center}

    /* F≈ëtartalom a sidebar mellett */
    .main{ margin-left: var(--sidebarW) }

    /* Hamburger (mobil) */
    .hamburger{
      display:none; border:1px solid var(--border); background:#fff; border-radius:10px;
      padding:.5rem .7rem; cursor:pointer;
    }
    .overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:25 }

    @media (max-width:900px){
      .sidebar{
        top:0; width:280px; transform:translateX(-100%); transition:transform .25s ease; border-right:none; border-radius:0;
      }
      .sidebar.open{ transform:translateX(0) }
      .main{ margin-left:0 }
      .hamburger{ display:inline-block }
      .overlay.show{ display:block }
      .container{ padding:14px }
    }

    /* Panelek, k√°rty√°k */
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .panel-head{ padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700 }
    .panel-body{ padding:16px }
    .grid{ display:grid; gap:14px }
    .grid-2{ grid-template-columns:1fr 1fr }
    .grid-3{ grid-template-columns:repeat(3,1fr) }
    .kpi{ padding:14px; border:1px solid var(--border); border-radius:12px; background:#fff }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .num{font-size:28px;font-weight:800;margin-top:6px}
    .kpi .delta{font-size:12px;margin-top:4px;color:var(--success)}

    .btn{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.55rem .8rem; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer;
    }
    .btn.primary{ background:var(--primary); color:#fff; border-color:var(--primary) }
    .btn.danger{ background:#fff; color:var(--danger); border-color:#f3d3d3 }
    .btn.secondary{ background:#f8fafc }
    .muted{ color:var(--muted) }
    input[type="text"], input[type="email"]{
      width:100%; padding:.6rem .7rem; border:1px solid var(--border); border-radius:10px; background:#fff
    }

    /* Tabs (pane-ek) */
    .tab-pane{ display:none }
    .tab-pane.active{ display:block }

    /* Layout (Trello board) */
    .board-wrap{ display:grid; grid-template-columns:repeat(3,minmax(260px,1fr)); gap:16px }
    .list{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow: var(--shadow);
      min-height:120px
    }
    .list-head{ display:flex; align-items:center; gap:8px; margin-bottom:10px }
    .list-title{ flex:1; font-weight:700; background:#e6eefc; border:0; padding:.55rem .7rem; border-radius:10px }
    .list-path{ flex:1; background:#e5f0ff; border:0; padding:.45rem .6rem; border-radius:8px }
    .cards{ display:flex; flex-direction:column; gap:8px; min-height:10px }
    .card-item{ display:flex; align-items:center; gap:8px; background:#eaf2ff; border:1px solid #dfebff; border-radius:10px; padding:.55rem .6rem; cursor:pointer; }
    .card-title{ flex:1; border:0; background:transparent; font-weight:600 }
    .list-foot{ margin-top:10px }

    @media (max-width:1100px){ .board-wrap{ grid-template-columns:repeat(2,minmax(240px,1fr)) } }
    @media (max-width:700px){ .board-wrap{ grid-template-columns:1fr } }

    /* Top pages lista */
    .top-row{ display:flex; justify-content:space-between; align-items:center; padding:.6rem .75rem; border:1px solid var(--border); border-radius:10px; background:#fff }
    .top-row+.top-row{ margin-top:8px }
    .top-path{ font-weight:600 }
    .top-meta{ font-size:12px; color:var(--muted) }
    .top-num{ font-weight:700 }

    .spacer{ height:14px }
  </style>
</head>

<body>
  <header class="appbar">
    <button id="sidebarToggle" class="hamburger" aria-label="Men√º" aria-expanded="false">‚ò∞</button>
    <div class="brand">Mesztor Admin</div>
    <div id="envBadge" class="badge"><span class="dot"></span><span class="label">Demo m√≥d</span></div>
    <div id="userBadge" class="muted" style="font-size:12px;"></div>
    <button id="logoutBtn" class="btn secondary" style="margin-left:8px;">Kil√©p√©s</button>
  </header>

  <div class="admin-shell">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar" aria-label="Oldals√≥ men√º">
      <div class="side-head">Men√º</div>
      <nav class="side-nav">
        <button class="side-link tab-btn active" data-pane="analytics"><span class="emoji">üìà</span>Analitika</button>
        <button class="side-link tab-btn" data-pane="layout"><span class="emoji">üß©</span>Be√°ll√≠t√°sok ‚Äì Layout</button>
        <button class="side-link tab-btn" data-pane="email"><span class="emoji">‚úâÔ∏è</span>Be√°ll√≠t√°sok ‚Äì Email</button>
        <button class="side-link tab-btn" data-pane="content"><span class="emoji">üìù</span>Be√°ll√≠t√°sok ‚Äì Tartalom</button>
        <button class="side-link tab-btn" data-pane="references"><span class="emoji">üì∏</span>Referencia fot√≥k</button>
        <button class="side-link tab-btn" data-pane="suppliers">
          <span class="emoji">üè¢</span>Besz√°ll√≠t√≥ partnerek
        </button>
        <button class="side-link tab-btn" data-pane="products">
          <span class="emoji">üì¶</span>
          <span>Term√©kek</span>
        </button>
        <button class="side-link tab-btn" data-pane="slider"><span class="emoji">üñºÔ∏è</span>F≈ëoldali slider</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Analitika -->
      <section id="pane-analytics" class="tab-pane active container">
        <div class="panel">
          <div class="panel-head">Oldal analitika</div>
          <div class="panel-body">
            <div class="muted" id="dateRangeLabel">Id≈ëszak</div>
            <div class="spacer"></div>
            <div class="grid grid-3">
              <div class="kpi">
                <div class="label">Munkamenetek</div>
                <div class="num" id="kpiSessions">0</div>
                <div class="delta" id="kpiSessionsChange">+0.0%</div>
              </div>
              <div class="kpi">
                <div class="label">Egyedi l√°togat√≥k</div>
                <div class="num" id="kpiUsers">0</div>
                <div class="delta" id="kpiUsersChange">+0.0%</div>
              </div>
              <div class="kpi">
                <div class="label">√Åtlagos session id≈ë</div>
                <div class="num" id="kpiAvgDuration">0p 00s</div>
                <div class="delta" id="kpiDurChange">+0.0%</div>
              </div>
            </div>

            <div class="spacer"></div>
            <div class="kpi">
              <div class="label">Oldalak / session</div>
              <div class="num" id="kpiPagesPerSession">0.00</div>
              <div class="delta" id="kpiPpsChange">+0.0%</div>
            </div>

            <div class="spacer"></div>
            <div class="panel" style="padding:16px">
              <canvas id="sessionsChart" height="220"></canvas>
            </div>

            <div class="spacer"></div>
            <div class="panel">
              <div class="panel-head">Top oldalak</div>
              <div class="panel-body" id="topPages">
                <div class="muted">Nincs adat</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Layout -->
      <section id="pane-layout" class="tab-pane container">
        <div class="panel">
          <div class="panel-head">
            Oldal szerkezet
            <button id="layoutSaveBtnBoards" class="btn primary" style="float:right">Ment√©s</button>
          </div>
          <div class="panel-body">
            <div class="muted" style="margin-bottom:10px">
              List√°k = oldalak (pl. <b>/</b>, <b>/termekek</b>). K√°rty√°k = szekci√≥k. H√∫zd, nevezd √°t, t√∂r√∂ld.
              <span id="layoutSaveStatus" class="muted" style="margin-left:8px"></span>
            </div>
            <div id="listsWrap" class="board-wrap"></div>
            <div class="spacer"></div>
            <button id="addListBtn" style="display:none" class="btn secondary">+ √öjabb lista hozz√°ad√°sa</button>
          </div>
        </div>
      </section>

      <!-- Email -->
      <section id="pane-email" class="tab-pane container">
        <div class="panel">
          <div class="panel-head">Email be√°ll√≠t√°s</div>
          <div class="panel-body">
            <form id="emailForm" class="grid" style="grid-template-columns:1fr auto; gap:10px">
              <input type="email" id="emailRecipient" placeholder="C√≠mzett email (pl. info@domain.hu)" />
              <button class="btn primary" type="submit">Ment√©s</button>
            </form>
            <div id="emailStatus" class="muted" style="margin-top:10px"></div>

            <hr style="margin:16px 0;border:none;border-top:1px solid #e5e7eb;" />

            <div class="muted" style="margin-bottom:8px; display: flex; justify-content: space-between; align-items: center; width: 100%;">
              <div>Jelsz√≥ csere</div>
              <div>
                
              </div>
            </div>

            <div style="display: flex; align-items: center; justify-content: center; flex-direction: column;">
              <form id="changePwForm" class="grid" style="grid-template-columns:1fr 1fr 1fr 0.5fr; gap:10px; align-items:center; width: 100%;">
                <input type="password" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px;" id="currentPw" placeholder="R√©gi jelsz√≥" autocomplete="current-password" required />
                <input type="password" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px;" id="newPw" placeholder="√öj jelsz√≥ (min. 8 karakter)" autocomplete="new-password" minlength="8" required />
                <input type="password" id="newPw2" placeholder="√öj jelsz√≥ √∫jra" autocomplete="new-password" minlength="8" style="width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px;" />
                <button class="btn primary" style="display: flex; align-items: center; justify-content: center; font-weight: bold; " type="submit">Jelsz√≥ csere</button>
              </form>
              
            </div>

            

            <div id="changePwStatus" class="muted" style="margin-top:10px"></div>

          </div>
          

        </div>
      </section>

      <!-- Tartalom -->
      <section id="pane-content" class="tab-pane container">
        <div class="panel">
          <div class="panel-head">Tartalom szerkeszt√©se</div>
          <div class="panel-body">
            <div class="muted" style="margin-bottom:10px">
              Az egyes modulokon bel√ºl a sz√∂vegre <b>kattintva tudod szerkeszteni</b> a tartalmat, ami az atadb√°zisba ment≈ëdik azonnal.
            </div>

            <iframe
              id="sitePreview"
              src=""
              style="width:100%; min-height:700px; border:1px solid #e5e7eb; border-radius:16px; background:#fff;"
            ></iframe>

            <script>
              (function () {
                const iframe = document.getElementById("sitePreview");
                const isAdminSubdomain = location.hostname.startsWith("admin.");

                const targetUrl = isAdminSubdomain
                  ? `${location.origin}/site/index.html?adminPreview=1`
                  : new URL("../index.html?adminPreview=1", location.href).toString();

                iframe.src = targetUrl;
              })();
            </script>


          </div>
        </div>
      </section>

      <!-- Besz√°ll√≠t√≥ partnerek -->
      <section id="pane-suppliers" class="tab-pane container">
        <div class="panel">
          <div class="panel-head">Besz√°ll√≠t√≥ partnerek log√≥i</div>
          <div class="panel-body">
            <p class="muted" style="margin-bottom:10px">
              Itt tudod be√°ll√≠tani a <b>‚ÄûMegb√≠zhat√≥ besz√°ll√≠t√≥ partnereink‚Äù</b> blokkban megjelen≈ë log√≥kat.
            </p>

            <form id="supplierForm" class="stack gap" style="max-width:480px;">
              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">N√©v</div>
                <input type="text" id="supplierName" placeholder="pl. H√∂rmann Hung√°ria Kft." />
              </label>

              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">Alc√≠m (opcion√°lis)</div>
                <input
                  type="text"
                  id="supplierSubtitle"
                  placeholder="pl. Automata bej√°ratok specialist√°ja"
                />
              </label>

              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">Log√≥ felt√∂lt√©se</div>
                <input type="file" id="supplierImage" accept="image/*" />
              </label>

              <div>
                <button type="submit" class="btn primary" style="margin-top:10px;">Besz√°ll√≠t√≥ ment√©se</button>
                <span id="supplierStatus" class="muted" style="margin-left:8px;"></span>
              </div>
            </form>

            <div class="spacer"></div>

            <h3 style="font-size:1rem;margin-bottom:.25rem;">Megl√©v≈ë besz√°ll√≠t√≥k</h3>
            <p class="muted" style="margin-bottom:.5rem;">
              Itt tudod <b>√°t√≠rni a nevet</b>, illetve <b>cser√©lni a log√≥t</b>, vagy t√∂r√∂lni a partnert.
            </p>
            <div id="suppliersList" class="stack gap"></div>
          </div>
        </div>
      </section>

      <!-- Term√©kek admin -->
      <section id="pane-products" class="tab-pane container">
        <h1 class="page-title">Term√©kv√°laszt√©k ‚Äì term√©kek</h1>

        <div class="panel" style="padding: 20px">
          <h2 class="panel-title">√öj term√©k felvitele</h2>
          <p class="muted">
            Add meg a term√©k nev√©t, r√∂vid √©s hosszabb le√≠r√°s√°t, valamint egy fot√≥t.
            Ezek fognak megjelenni a f≈ëoldali ‚ÄûTerm√©kv√°laszt√©k‚Äù k√°rty√°kon √©s a
            r√©szletes term√©koldalon.
          </p>

          <form id="productForm" class="stack gap">
            <label>
              <div style="font-size:.8rem;margin-bottom:.15rem;">Term√©k neve</div>
              <input
                type="text"
                id="productName"
                placeholder="pl. Szigetelt szekcion√°lt gar√°zskapu"
              />
            </label>

            <label>
              <div style="font-size:.8rem;margin-bottom:.15rem;">R√∂vid le√≠r√°s (k√°rty√°ra)</div>
              <textarea
                id="productShort"
                rows="2"
                style="width:100%;resize:vertical;"
                placeholder="pl. 40 mm panel, motoros m≈±k√∂dtet√©s, 5 √©v garancia."
              ></textarea>
            </label>

            <label>
              <div style="font-size:.8rem;margin-bottom:.15rem;">R√©szletes le√≠r√°s (r√©szletek oldalra)</div>
              <textarea
                id="productLong"
                rows="6"
                style="width:100%;resize:vertical;"
                placeholder="Ide √≠rhatod a r√©szletes m≈±szaki param√©tereket, garanci√°t, kieg√©sz√≠t≈ëket stb."
              ></textarea>
            </label>

            <label>
              <div style="font-size:.8rem;margin-bottom:.15rem;">Term√©k fot√≥</div>
              <input type="file" id="productImage" accept="image/*" />
            </label>

            <div>
              <button type="submit" class="btn primary" style="margin-top:10px;">
                Term√©k ment√©se
              </button>
              <span id="productStatus" class="muted" style="margin-left:8px;"></span>
            </div>
          </form>
        </div>

        <div class="spacer"></div>

        <div class="panel" style="padding: 20px">
          <h2 class="panel-title" style="margin-bottom:.25rem;">Megl√©v≈ë term√©kek</h2>
          <p class="muted" style="margin-bottom:.5rem;">
            A leg√∫jabb term√©kek jelennek meg el√∂l. A t√∂rl√©s v√©gleges.
          </p>
          <div id="productsList" class="stack gap"></div>
        </div>
      </section>

            <!-- F≈ëoldali slider -->
      <section id="pane-slider" class="tab-pane container">
        <div class="panel">
          <div class="panel-head">F≈ëoldali slider ‚Äì k√©pek</div>
          <div class="panel-body">
            <p class="muted" style="margin-bottom:10px">
              Itt tudod be√°ll√≠tani a f≈ëoldalon megjelen≈ë <b>automatikusan lapoz√≥d√≥ k√©pslidet</b>.
              A k√©pek a Firebase Realtime Database <code>heroSlider</code> √°g√°ban t√°rol√≥dnak base64 form√°ban.
            </p>

            <form id="sliderForm" class="stack gap" style="max-width:480px;">
              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">C√≠m (opcion√°lis)</div>
                <input type="text" id="slideTitle" placeholder="pl. Ipari szekcion√°lt kapuk" />
              </label>

              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">Alc√≠m / r√∂vid le√≠r√°s (opcion√°lis)</div>
                <input
                  type="text"
                  id="slideSubtitle"
                  placeholder="pl. Nagy ig√©nybev√©telre tervezett ipari megold√°sok"
                />
              </label>

              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">K√©p felt√∂lt√©se</div>
                <input type="file" id="slideImage" accept="image/*" />
              </label>

              <div>
                <button type="submit" class="btn primary" style="margin-top:10px;">
                  Diak√©p ment√©se
                </button>
                <span id="sliderStatus" class="muted" style="margin-left:8px;"></span>
              </div>
            </form>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="panel">
          <div class="panel-head">Megl√©v≈ë slider k√©pek</div>
          <div class="panel-body">
            <p class="muted" style="margin-bottom:6px;">
              A k√©pek abban a sorrendben jelennek meg a f≈ëoldali sliderben, ahogy itt l√°tszanak.
              A sorrendet jelenleg a felt√∂lt√©s ideje hat√°rozza meg (legr√©gebbi el√∂l).
            </p>
            <div id="sliderList" class="stack gap"></div>
          </div>
        </div>
      </section>




      <!-- Referencia fot√≥k -->
      <section id="pane-references" class="tab-pane container">
        <div class="panel">
          <div class="panel-head">Referencia fot√≥k</div>
          <div class="panel-body">
            <p class="muted" style="margin-bottom:10px">
              Itt tudsz referencia k√°rty√°kat l√©trehozni. Ezek a <b>‚ÄûReferenci√°ink‚Äù</b> blokkban jelennek meg a f≈ëoldalon.
            </p>

            <form id="referencesForm" class="stack gap" style="max-width:480px;">
              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">C√≠m (opcion√°lis)</div>
                <input type="text" id="refTitle" placeholder="pl. Ipari szekcion√°lt kapu" />
              </label>

              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">R√∂vid le√≠r√°s</div>
                <textarea
                  id="refDesc"
                  rows="3"
                  style="width:100%;resize:vertical;"
                  placeholder="pl. Ipari kaputechnika kivitelez√©s Sz√©kesfeh√©rv√°ron."
                ></textarea>
              </label>

              <label>
                <div style="font-size:.8rem;margin-bottom:.15rem;">K√©p felt√∂lt√©se</div>
                <input type="file" id="refImage" accept="image/*" />
              </label>

              <div>
                <button type="submit" class="btn primary" style="margin-top:10px;">Referencia ment√©se</button>
                <span id="referencesStatus" class="muted" style="margin-left:8px;"></span>
              </div>
            </form>

            <div class="spacer"></div>

            <h3 style="font-size:1rem;margin-bottom:.25rem;">Megl√©v≈ë referenci√°k</h3>
            <p class="muted" style="margin-bottom:.5rem;">
              A legfrissebbek vannak fel√ºl. A t√∂rl√©s nem visszavonhat√≥.
            </p>
            <div id="referencesList" class="stack gap"></div>
          </div>
        </div>
      </section>



    </main>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <!-- Main module -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref as dbRef, get, set, update as dbUpdate, push, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/modular/sortable.esm.js";

    /* ---------- Firebase config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAZUGCJkn9L4xH_M8L0fZYTUresZ9qYPqo",
      authDomain: "flymeto-696d0.firebaseapp.com",
      databaseURL: "https://flymeto-696d0-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "flymeto-696d0",
      storageBucket: "flymeto-696d0.firebasestorage.app",
      messagingSenderId: "651204605205",
      appId: "1:651204605205:web:d5dfbf3698be7ac6ee251c",
      measurementId: "G-4L7YN2X9YL"
    };

    let app, dbRealtime, dbFirestore, fs, firebaseEnabled = false;
    const envBadgeEl = document.getElementById("envBadge");
    try{
      app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      dbRealtime = getDatabase(app);
      dbFirestore = getFirestore(app);
      firebaseEnabled = true;
      envBadgeEl.classList.add("ok");
      envBadgeEl.querySelector(".label").textContent = "Firebase akt√≠v";
    }catch(e){
      console.warn("Firebase init hiba, dem√≥ m√≥d:", e);
      firebaseEnabled = false;
      envBadgeEl.classList.remove("ok");
      envBadgeEl.querySelector(".label").textContent = "Demo m√≥d";
    }


const changePwForm = document.getElementById("changePwForm");
const currentPwEl  = document.getElementById("currentPw");
const newPwEl      = document.getElementById("newPw");
const newPw2El     = document.getElementById("newPw2");
const changePwStatus = document.getElementById("changePwStatus");

changePwForm?.addEventListener("submit", async (e) => {
  e.preventDefault();

  const user = auth.currentUser;
  if (!user?.email) {
    changePwStatus.textContent = "Nem vagy bejelentkezve.";
    return;
  }

  // FONTOS: nincs trim()
  const currentPw = (currentPwEl?.value ?? "");
  const newPw  = (newPwEl?.value ?? "");
  const newPw2 = (newPw2El?.value ?? "");

  if (!currentPw || !newPw || !newPw2) {
    changePwStatus.textContent = "T√∂lts ki minden mez≈ët.";
    return;
  }
  if (newPw.length < 8) {
    changePwStatus.textContent = "Az √∫j jelsz√≥ legyen legal√°bb 8 karakter.";
    return;
  }
  if (newPw !== newPw2) {
    changePwStatus.textContent = "Az √∫j jelszavak nem egyeznek.";
    return;
  }
  if (currentPw === newPw) {
    changePwStatus.textContent = "Az √∫j jelsz√≥ nem lehet ugyanaz, mint a r√©gi.";
    return;
  }

  changePwStatus.textContent = "R√©gi jelsz√≥ ellen≈ërz√©se‚Ä¶";

  try {
    const cred = EmailAuthProvider.credential(user.email, currentPw);
    await reauthenticateWithCredential(user, cred);

    changePwStatus.textContent = "Jelsz√≥ ment√©se‚Ä¶";
    await updatePassword(user, newPw);

    changePwStatus.textContent = "Sikeres jelsz√≥csere ‚úÖ";
    currentPwEl.value = "";
    newPwEl.value = "";
    newPw2El.value = "";
  } catch (err) {
    console.warn("[changePassword] hiba:", err);
    const code = err?.code || "";

    if (code === "auth/wrong-password" || code === "auth/invalid-credential") {
      changePwStatus.textContent = "Hib√°s r√©gi jelsz√≥.";
    } else if (code === "auth/too-many-requests") {
      changePwStatus.textContent = "T√∫l sok pr√≥b√°lkoz√°s. Pr√≥b√°ld k√©s≈ëbb.";
    } else if (code === "auth/requires-recent-login") {
      changePwStatus.textContent = "K√©rlek l√©pj ki √©s be √∫jra, majd pr√≥b√°ld meg.";
    } else {
      changePwStatus.textContent = "Nem siker√ºlt a jelsz√≥t cser√©lni. (" + code + ")";
    }
  }
});



/* ---------- Auth guard (admin csak bejelentkezve) ---------- */
    const auth = getAuth(app);
    try { await setPersistence(auth, browserLocalPersistence); } catch {}

    const LOGIN_URL = "./login.html";
    const next = encodeURIComponent(location.pathname + location.search + location.hash);

    const userBadgeEl = document.getElementById("userBadge");
    const logoutBtn = document.getElementById("logoutBtn");

    // V√°rjuk meg az auth √°llapotot, miel≈ëtt b√°rmit megjelen√≠t√ºnk
    await new Promise((resolve) => {
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          // nincs bejelentkez√©s -> login
          location.replace(`${LOGIN_URL}?next=${next}`);
          return;
        }
        if (userBadgeEl) userBadgeEl.textContent = user.email ? `Bejelentkezve: ${user.email}` : "Bejelentkezve";
        document.body.classList.add("authed");
        resolve();
      });
    });

    logoutBtn?.addEventListener("click", async () => {
      try { await signOut(auth); } finally {
        location.replace(`${LOGIN_URL}?next=${next}`);
      }
    });

    /* ---------- Sidebar / Tabs / Hamburger ---------- */
    const tabs  = document.querySelectorAll('.tab-btn');
    const panes = document.querySelectorAll('.tab-pane');
    function activatePane(btn){
      tabs.forEach(b => b.classList.toggle('active', b === btn));
      panes.forEach(p => p.classList.toggle('active', p.id === 'pane-'+btn.dataset.pane));
    }
    tabs.forEach(btn => btn.addEventListener('click', ()=>{
      activatePane(btn);
      if (window.innerWidth <= 900) closeSidebar();
    }));

    const sidebarEl = document.getElementById('sidebar');
    const overlayEl = document.getElementById('overlay');
    const toggleBtn = document.getElementById('sidebarToggle');
    function openSidebar(){ sidebarEl.classList.add('open'); overlayEl.classList.add('show'); document.body.style.overflow='hidden'; toggleBtn?.setAttribute('aria-expanded','true'); }
    function closeSidebar(){ sidebarEl.classList.remove('open'); overlayEl.classList.remove('show'); document.body.style.overflow=''; toggleBtn?.setAttribute('aria-expanded','false'); }
    toggleBtn?.addEventListener('click', ()=> sidebarEl.classList.contains('open')? closeSidebar() : openSidebar());
    overlayEl?.addEventListener('click', closeSidebar);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSidebar(); });

    /* ---------- Helper-ek ---------- */
    const uid  = ()=>"id_"+Math.random().toString(36).slice(2,9);
    const slug = s => (s||"").toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"").replace(/\-+/g,"-");
    const toHHMMSS = (sec)=>{ const s=Math.max(0,Math.round(+sec||0)); const m=Math.floor(s/60), r=s%60; return `${m}p ${String(r).padStart(2,"0")}s`; };

    
    /* ---------- Firestore + k√©pt√∂m√∂r√≠t√©s be√°ll√≠t√°sok ---------- */

    // √Åtmeneti kompatibilit√°s: ha a publikus oldal m√©g RTDB-b≈ël olvas, akkor ideiglenesen √°ll√≠tsd true-ra.
    // Ha m√°r a publikus oldal is Firestore-b√≥l olvas, maradjon false (√≠gy nem √≠rsz t√∂bb adatot RTDB-be).
    const WRITE_RTD_BK = false;

    const hasFS = () => firebaseEnabled && !!dbFirestore;
    const hasRTDB = () => firebaseEnabled && !!dbRealtime;

    async function fsGetSingleton(col, id){
      if(!hasFS()) return null;
      const s = await getDoc(doc(dbFirestore, col, id));
      return s.exists() ? (s.data() || null) : null;
    }

    async function fsSetSingleton(col, id, data, { merge=true } = {}){
      if(!hasFS()) return;
      await setDoc(doc(dbFirestore, col, id), data, { merge });
    }

    async function fsListAll(col){
      if(!hasFS()) return [];
      const snap = await getDocs(collection(dbFirestore, col));
      return snap.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
    }

    async function fsUpsert(col, id, data, { merge=true } = {}){
      if(!hasFS()) return;
      await setDoc(doc(dbFirestore, col, id), data, { merge });
    }

    async function fsDelete(col, id){
      if(!hasFS()) return;
      await deleteDoc(doc(dbFirestore, col, id));
    }

    // K√©p t√∂m√∂r√≠t√©s + √°tm√©retez√©s: drasztikusan cs√∂kkenti a let√∂lt√∂tt MB-okat.
    // Firestore limit: egy dokumentum max ~1 MiB. Ha t√∫l nagy, jelezni fogjuk.
    async function fileToOptimizedDataUrl(file, { maxW=1200, maxH=1200, mime="image/webp", quality=0.78 } = {}){
      if(!file) return null;

      const blobUrl = URL.createObjectURL(file);
      try{
        const img = await new Promise((resolve, reject) => {
          const im = new Image();
          im.onload = () => resolve(im);
          im.onerror = (e) => reject(e);
          im.src = blobUrl;
        });

        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        const scale = Math.min(1, maxW / w, maxH / h);

        const cw = Math.max(1, Math.round(w * scale));
        const ch = Math.max(1, Math.round(h * scale));

        const canvas = document.createElement("canvas");
        canvas.width = cw;
        canvas.height = ch;

        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(img, 0, 0, cw, ch);

        const dataUrl = canvas.toDataURL(mime, quality);

        // Durva korl√°t: ~950k karakter felett m√°r k√∂nnyen Firestore 1MiB f√∂l√© cs√∫szik (base64 overhead miatt).
        if (dataUrl && dataUrl.length > 950000) {
          throw new Error("A k√©p m√©g t√∂m√∂r√≠t√©s ut√°n is t√∫l nagy. Pr√≥b√°ld kisebb k√©ppel, vagy cs√∂kkentsd a felbont√°st/min≈ës√©get.");
        }

        return dataUrl;
      } finally {
        URL.revokeObjectURL(blobUrl);
      }
    }

    // Egyszeri migr√°ci√≥: RTDB -> Firestore (adatok m√°sol√°sa, t√∂rl√©s n√©lk√ºl)
    async function migrateRtdbToFirestore(){
      if(!hasFS() || !hasRTDB()){
        alert("Firebase nincs inicializ√°lva (Firestore/RTDB).");
        return;
      }

      const ok = confirm("RTDB ‚Üí Firestore migr√°ci√≥ indul. (Nem t√∂rl√ºnk RTDB-b≈ël.)\n\nOK = indul, M√©gse = kil√©p.");
      if(!ok) return;

      const status = (msg)=>console.log("[migrate]", msg);

      // ---- Firestore m√©ret limitek: 10 MiB / request, 1 MiB / doc ----
      // https://firebase.google.com/docs/firestore/quotas
      const SAFE_MAX_REQUEST_BYTES = 7_500_000; // tartsunk b≈ëven 10 MiB alatt
      const SAFE_MAX_OPS = 200;                 // b≈ëven 500 alatt

      const estBytes = (obj) => {
        try { return new TextEncoder().encode(JSON.stringify(obj)).length; }
        catch { return (JSON.stringify(obj) || "").length; }
      };

      const isDataUrl = (v) => typeof v === "string" && v.startsWith("data:image/");

      const compressDataUrl = async (dataUrl, maxW=1200, quality=0.78) => {
        // Visszaad egy (j√≥ es√©llyel) kisebb webp dataURL-t
        return await new Promise((resolve) => {
          try{
            const img = new Image();
            img.onload = () => {
              const scale = Math.min(1, maxW / (img.width || maxW));
              const w = Math.max(1, Math.round((img.width || maxW) * scale));
              const h = Math.max(1, Math.round((img.height || maxW) * scale));
              const canvas = document.createElement("canvas");
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, w, h);
              // webp t√∂m√∂r√≠t√©s
              const out = canvas.toDataURL("image/webp", quality);
              resolve(out || dataUrl);
            };
            img.onerror = () => resolve(dataUrl);
            img.src = dataUrl;
          }catch(_e){
            resolve(dataUrl);
          }
        });
      };

      const normalizeImagesDeep = async (obj, maxW=1200, quality=0.78) => {
        if(Array.isArray(obj)){
          for(let i=0;i<obj.length;i++) obj[i] = await normalizeImagesDeep(obj[i], maxW, quality);
          return obj;
        }
        if(obj && typeof obj === "object"){
          for(const k of Object.keys(obj)) obj[k] = await normalizeImagesDeep(obj[k], maxW, quality);
          return obj;
        }
        if(isDataUrl(obj)){
          // csak a nagyon nagyokat t√∂m√∂r√≠ts√ºk ‚Äì gyorsabb
          if(obj.length > 120_000) return await compressDataUrl(obj, maxW, quality);
          return obj;
        }
        return obj;
      };

      const migrateEntriesToCollection = async (entries, fsCol) => {
        let batch = writeBatch(dbFirestore);
        let ops = 0;
        let bytes = 0;
        let migrated = 0;
        let skipped = 0;

        for(const [id, raw] of entries){
          // clone (nehogy a mem√≥ri√°ban fel√ºl√≠rjuk az eredetit)
          let data = raw || {};
          try { data = JSON.parse(JSON.stringify(data)); } catch {}

          // 1) alapt√∂m√∂r√≠t√©s (webp + resize)
          data = await normalizeImagesDeep(data, 1200, 0.78);

          // 2) ha m√©g mindig nagy, agressz√≠vebben
          let dbytes = estBytes(data);
          if(dbytes > 950_000){
            data = await normalizeImagesDeep(data, 800, 0.70);
            dbytes = estBytes(data);
          }

          // 3) ha m√©g mindig t√∫l nagy: kihagyjuk (Firestore 1MiB/doc limit)
          if(dbytes >= 1_048_000){
            skipped++;
            status(`‚ö†Ô∏è SKIP ${fsCol}/${id} t√∫l nagy (~${dbytes} byte). Ilyet Firestore nem tud t√°rolni (1MiB/doc).`);
            continue;
          }

          // ha a k√∂vetkez≈ë m≈±velet t√∫l nagy request-et csin√°lna, commit
          if(ops >= SAFE_MAX_OPS || (bytes + dbytes) >= SAFE_MAX_REQUEST_BYTES){
            await batch.commit();
            batch = writeBatch(dbFirestore);
            ops = 0; bytes = 0;
          }

          batch.set(doc(dbFirestore, fsCol, id), data, { merge:false });
          ops++; bytes += dbytes; migrated++;
        }

        if(ops > 0) await batch.commit();
        status(`‚úÖ ${fsCol}: migr√°lva=${migrated}, kihagyva=${skipped}`);
      };

      try{
        // Settings: email
        status("settings/email");
        const emailSnap = await get(dbRef(dbRealtime, "settings/email"));
        if(emailSnap.exists()){
          await fsSetSingleton("settings", "email", emailSnap.val() || {}, { merge:false });
        }

        // Settings: layoutBoards
        status("settings/layoutBoards");
        const boardSnap = await get(dbRef(dbRealtime, "settings/layoutBoards"));
        if(boardSnap.exists()){
          await fsSetSingleton("settings", "layoutBoards", boardSnap.val() || {}, { merge:false });
        }

        // Content sections
        status("content/sections -> contentSections/*");
        const contentSnap = await get(dbRef(dbRealtime, "content/sections"));
        if(contentSnap.exists()){
          const all = contentSnap.val() || {};
          await migrateEntriesToCollection(Object.entries(all), "contentSections");
        }

        // Collections
        async function migrateCollection(rtdbPath, fsCol){
          status(`${rtdbPath} -> ${fsCol}/*`);
          const snap = await get(dbRef(dbRealtime, rtdbPath));
          if(!snap.exists()) return;
          const val = snap.val() || {};
          await migrateEntriesToCollection(Object.entries(val), fsCol);
        }

        await migrateCollection("suppliers", "suppliers");
        await migrateCollection("references", "references");
        await migrateCollection("products", "products");
        await migrateCollection("heroSlider", "heroSlider");

        status("‚úÖ Migr√°ci√≥ k√©sz.");
        alert("K√©sz! RTDB ‚Üí Firestore migr√°ci√≥ befejezve.\n\nMost √°ll√≠tsd √°t az admin ment√©seket Firestore-ra (ez a f√°jl m√°r √≠gy van), √©s a publikus oldalt is √©rdemes Firestore bet√∂lt√©sre refaktor√°lni.");
      }catch(err){
        console.warn("[migrate] hiba:", err);
        alert("Migr√°ci√≥ k√∂zben hiba t√∂rt√©nt. N√©zd meg a console-t.");
      }
    }

    // Fut√°s DevTools-b√≥l: window.migrateRtdbToFirestore()
    window.migrateRtdbToFirestore = migrateRtdbToFirestore;

/* ---------- Analitika (Realtime DB -> aggreg√°l√°s) ---------- */
    const kpiSessionsEl     = document.getElementById("kpiSessions");
    const kpiUsersEl        = document.getElementById("kpiUsers");
    const kpiAvgDurationEl  = document.getElementById("kpiAvgDuration");
    const kpiPagesPerSessEl = document.getElementById("kpiPagesPerSession");
    const kpiSessionsChEl   = document.getElementById("kpiSessionsChange");
    const kpiUsersChEl      = document.getElementById("kpiUsersChange");
    const kpiDurChEl        = document.getElementById("kpiDurChange");
    const kpiPpsChEl        = document.getElementById("kpiPpsChange");
    const dateRangeLabelEl  = document.getElementById("dateRangeLabel");
    const topPagesEl        = document.getElementById("topPages");
    let sessionsChart;

    const demoAnalytics = {
      dateRangeLabel: "Ut√≥bbi 7 nap (demo)",
      byDay: [
        { day: "2025-11-14", sessions: 31, users: 26, avgSessionSeconds: 140, pageviews: 81 },
        { day: "2025-11-15", sessions:  2, users:  2, avgSessionSeconds: 120, pageviews:  5 },
        { day: "2025-11-16", sessions:  3, users:  3, avgSessionSeconds: 160, pageviews:  7 },
        { day: "2025-11-17", sessions:  3, users:  3, avgSessionSeconds: 170, pageviews:  8 },
        { day: "2025-11-18", sessions:  3, users:  3, avgSessionSeconds: 170, pageviews:  8 },
        { day: "2025-11-19", sessions:  1, users:  1, avgSessionSeconds: 100, pageviews:  2 },
        { day: "2025-11-20", sessions:  2, users:  2, avgSessionSeconds: 160, pageviews:  6 }
      ],
      topPages: [
        { path:"/", sessions: 18, avgSeconds: 180 },
        { path:"/szolgaltatasok", sessions: 11, avgSeconds: 160 },
        { path:"/referenciak", sessions:  8, avgSeconds: 200 },
        { path:"/kapcsolat", sessions:  6, avgSeconds:  95 },
      ],
      prevPeriod: { sessions: 60, users: 50, avgSessionSeconds: 145, pageviewsPerSession: 2.9 },
      deviceStats: { mobile:60, tablet:15, desktop:25 }
    };

    function fmtShort(iso){ const d=new Date(iso); if(isNaN(d)) return iso; return d.toLocaleDateString("hu-HU",{month:"2-digit",day:"2-digit"}); }
    function pct(cur, prev){ if(!prev) return 0; return ((cur-prev)/prev)*100; }
    function deviceType(ua=""){const u=ua.toLowerCase(); if(/mobile|iphone|ipod|android.*mobile/.test(u))return"mobile"; if(/ipad|tablet|android(?!.*mobile)/.test(u))return"tablet"; return"desktop";}

    function buildTopPagesFromSessions(sessions){
      const map=new Map();
      sessions.forEach(s=>{
        const path = s.firstPage || s.lastPage || "/";
        const dur  = Number(s.durationSec||0);
        const item = map.get(path)||{path,sessions:0,totalDur:0};
        item.sessions++; item.totalDur+=dur; map.set(path,item);
      });
      return [...map.values()].map(x=>({path:x.path, sessions:x.sessions, avgSeconds:x.totalDur/x.sessions}))
               .sort((a,b)=>b.sessions-a.sessions).slice(0,5);
    }

    function buildAnalyticsFromSessions(sessions){
      if(!sessions?.length) return demoAnalytics;
      const byDate=new Map(), visitors=new Set(); let totalDur=0,totalPv=0;
      sessions.forEach(s=>{
        const t = s.startedAt || s.lastUpdatedAt || Date.now();
        const d = new Date(t); if(isNaN(d)) return;
        const key = d.toISOString().slice(0,10);
        const rec = byDate.get(key)||{day:key,sessions:0,sumDur:0,pageviews:0,userSet:new Set()};
        rec.sessions++; const dur=+s.durationSec||0; rec.sumDur+=dur; totalDur+=dur;
        const pv=+s.pageViews||0; rec.pageviews+=pv; totalPv+=pv;
        if(s.visitorId) {rec.userSet.add(s.visitorId); visitors.add(s.visitorId);}
        rec.device = deviceType(s.userAgent||"");
        byDate.set(key,rec);
      });
      const days=[...byDate.values()].sort((a,b)=>a.day.localeCompare(b.day))
        .map(r=>({day:r.day, sessions:r.sessions, users:r.userSet.size||r.sessions, avgSessionSeconds:r.sumDur/r.sessions, pageviews:r.pageviews}));
      const totalSessions=days.reduce((s,d)=>s+d.sessions,0);
      const uniqueVisitors = visitors.size || totalSessions;
      const avgDur = totalSessions? days.reduce((s,d)=>s+d.avgSessionSeconds*d.sessions,0)/totalSessions : 0;
      const pps    = totalSessions? totalPv/totalSessions : 0;
      return {
        dateRangeLabel: "√ñsszes √∂sszegy≈±jt√∂tt adat",
        byDay: days,
        topPages: buildTopPagesFromSessions(sessions),
        prevPeriod: { sessions: totalSessions, users: uniqueVisitors, avgSessionSeconds: avgDur, pageviewsPerSession: pps },
        deviceStats: {} // opcion√°lis
      };
    }

    function setDelta(el,value){ const txt=(value>=0?"+":"")+value.toFixed(1)+"%"; el.textContent=txt; el.style.color = value>=0? "var(--success)":"var(--danger)"; }
    function renderTopPages(data){
      const pages=data.topPages||[];
      if(!pages.length){ topPagesEl.innerHTML='<div class="muted">Nincs adat.</div>'; return; }
      topPagesEl.innerHTML="";
      pages.forEach(p=>{
        const row=document.createElement("div"); row.className="top-row";
        const left=document.createElement("div"); left.innerHTML=`<div class="top-path">${p.path}</div><div class="top-meta">${p.sessions} session ¬∑ ${toHHMMSS(p.avgSeconds)}</div>`;
        const right=document.createElement("div"); right.className="top-num"; right.textContent=p.sessions.toLocaleString("hu-HU");
        row.appendChild(left); row.appendChild(right); topPagesEl.appendChild(row);
      });
    }

    async function loadAnalytics(){
      if(!firebaseEnabled || !dbRealtime){
        const d=demoAnalytics; updateKpisAndChart(d); return;
      }
      try{
        const snap=await get(dbRef(dbRealtime,"analytics/sessions"));
        if(!snap.exists()){ updateKpisAndChart(demoAnalytics); return; }
        const sessions = Object.values(snap.val()||{});
        const d = buildAnalyticsFromSessions(sessions);
        updateKpisAndChart(d);
      }catch(e){
        console.warn("[analytics] hiba:", e);
        updateKpisAndChart(demoAnalytics);
      }
    }

    function updateKpisAndChart(d){
      const days=d.byDay||[];
      const totalSessions = days.reduce((s,x)=>s+x.sessions,0);
      const totalUsers    = days.reduce((s,x)=>s+x.users,0);
      const totalPv       = days.reduce((s,x)=>s+x.pageviews,0);
      const avgDur        = totalSessions? days.reduce((s,x)=>s+x.avgSessionSeconds*x.sessions,0)/totalSessions : 0;
      const pps           = totalSessions? totalPv/totalSessions : 0;

      kpiSessionsEl.textContent = totalSessions.toLocaleString("hu-HU");
      kpiUsersEl.textContent    = totalUsers.toLocaleString("hu-HU");
      kpiAvgDurationEl.textContent = toHHMMSS(avgDur);
      kpiPagesPerSessEl.textContent = pps.toFixed(2);

      // (demo jelleg≈±) √∂sszevet√©s el≈ëz≈ë id≈ëszakkal
      setDelta(kpiSessionsChEl, pct(totalSessions, d.prevPeriod?.sessions||totalSessions));
      setDelta(kpiUsersChEl,    pct(totalUsers,    d.prevPeriod?.users||totalUsers));
      setDelta(kpiDurChEl,      pct(avgDur,        d.prevPeriod?.avgSessionSeconds||avgDur));
      setDelta(kpiPpsChEl,      pct(pps,           d.prevPeriod?.pageviewsPerSession||pps));

      dateRangeLabelEl.textContent = d.dateRangeLabel||"Id≈ëszak";

      const labels = days.map(x=>fmtShort(x.day));
      const series = days.map(x=>x.sessions);
      if(sessionsChart) sessionsChart.destroy();
      sessionsChart = new Chart(document.getElementById("sessionsChart").getContext("2d"), {
        type:"line",
        data:{ labels, datasets:[{ label:"Munkamenetek", data:series, tension:.35, borderWidth:2, pointRadius:3, fill:false }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });

      renderTopPages(d);
    }

    /* ---------- Layout (Trello board, Firestore) ---------- */
    const listsWrap = document.getElementById("listsWrap");
    const addListBtn = document.getElementById("addListBtn");
    const saveBtnBoards = document.getElementById("layoutSaveBtnBoards");
    const saveStatusEl = document.getElementById("layoutSaveStatus");

    let board = { version:2, updatedAt: Date.now(), lists: [] };
    let autosaveTimer=null;

    function autoSave(){ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveBoard, 600); }

    function listTemplate(list){
      return `
        <div class="list" data-id="${list.id}">
          <div class="list-head">
            <input class="list-title" type="text" value="${list.title||""}" placeholder="Lista neve (pl. F≈ëoldal)" />
            <button class="btn danger del-list" title="Lista t√∂rl√©se">üóë</button>
          </div>
          <div class="list-head" style="margin-top:-6px">
            <input class="list-path" type="text" value="${list.path||"/"}" placeholder="/√∫tvonal (pl. /, /termekek)" />
          </div>
          <div class="cards" id="cards-${list.id}"></div>
          <div style="display:none" class="list-foot"><button class="btn secondary add-card" type="button">+ K√°rtya hozz√°ad√°sa</button></div>
        </div>`;
    }
    function cardTemplate(card){
      return `
        <div class="card-item" data-id="${card.id}">
          <input class="card-title" type="text" value="${card.title||""}" />
          <button class="btn danger del-card" title="K√°rtya t√∂rl√©se">üóë</button>
        </div>`;
    }

    function renderBoard(){
      listsWrap.innerHTML="";
      board.lists.forEach(list=>{
        const wrap=document.createElement("div"); wrap.innerHTML=listTemplate(list);
        const listEl=wrap.firstElementChild; const cardsEl=listEl.querySelector(".cards");
        (list.cards||[]).forEach(c=>{ const cw=document.createElement("div"); cw.innerHTML=cardTemplate(c); cardsEl.appendChild(cw.firstElementChild); });

        // Sortable cards
        new Sortable(cardsEl,{ group:"cards", animation:150, onEnd:()=>{ syncFromDOM(); autoSave(); } });

        // inputs/listeners
        listEl.querySelector(".list-title").addEventListener("input", ()=>{ syncFromDOM(); autoSave(); });
        listEl.querySelector(".list-path").addEventListener("input",  ()=>{ syncFromDOM(); autoSave(); });
        listEl.querySelector(".add-card").addEventListener("click", ()=>{
          const id=uid(); list.cards.push({ id, key:`sec-${id.slice(-4)}`, title:"√∫j szekci√≥" }); renderBoard(); autoSave();
        });
        listEl.querySelector(".del-list").addEventListener("click", ()=>{
          if(!confirm("Biztosan t√∂rl√∂d a list√°t az √∂sszes k√°rty√°val?")) return;
          board.lists=board.lists.filter(x=>x.id!==list.id); renderBoard(); autoSave();
        });

        // per-card listeners
        cardsEl.querySelectorAll(".card-item").forEach(ci=>{
          ci.querySelector(".card-title").addEventListener("input", ()=>{ syncFromDOM(); autoSave(); });
          ci.querySelector(".del-card").addEventListener("click", ()=>{
            const cid=ci.dataset.id; list.cards=list.cards.filter(c=>c.id!==cid); renderBoard(); autoSave();
          });
        });

        listsWrap.appendChild(listEl);
      });

      // Sortable lists
      new Sortable(listsWrap,{ animation:150, draggable:".list", onEnd:()=>{ syncFromDOM(); autoSave(); } });
    }

    function syncFromDOM(){
      const lists=[];
      listsWrap.querySelectorAll(".list").forEach(listEl=>{
        const id=listEl.dataset.id, title=listEl.querySelector(".list-title").value.trim()||"Lista", path=listEl.querySelector(".list-path").value.trim()||"/";
        const cards=[]; listEl.querySelectorAll(".card-item").forEach(ci=>{ const cid=ci.dataset.id; const ttl=ci.querySelector(".card-title").value.trim()||"szekci√≥"; cards.push({ id:cid, title:ttl, key:slug(ttl) }); });
        lists.push({ id, title, path, cards });
      });
      board.lists=lists; board.updatedAt=Date.now();
    }

    async function saveBoard(){
      if(!firebaseEnabled || !dbFirestore){
        saveStatusEl.textContent="Demo m√≥dban lok√°lisan friss√≠tve."; 
        setTimeout(()=>saveStatusEl.textContent="",1200); 
        return;
      }
      try{ 
        const payload = { ...(board||{}), updatedAt: Date.now() };
        await setDoc(doc(dbFirestore,"settings","layoutBoards"), payload, { merge:false });

        if (WRITE_RTD_BK && dbRealtime) {
          await set(dbRef(dbRealtime,"settings/layoutBoards"), payload);
        }

        saveStatusEl.textContent="Mentve ‚úÖ"; 
        setTimeout(()=>saveStatusEl.textContent="",1200); 
      }
      catch(e){ 
        console.warn("[layoutBoards] ment√©si hiba:", e); 
        saveStatusEl.textContent="Hiba a ment√©sn√©l."; 
      }
    }
    async function loadBoard(){
      const seed={
        version:2, updatedAt: Date.now(),
        lists:[
          { id:uid(), title:"F≈ëoldal", path:"/", cards:[ {id:uid(),key:"hero",title:"hero"}, {id:uid(),key:"miert-mi",title:"mi√©rt mi"}, {id:uid(),key:"szolgaltatasok",title:"szolg√°ltat√°sok"}, {id:uid(),key:"projects",title:"projects"}, {id:uid(),key:"footer",title:"footer"} ]},
          { id:uid(), title:"Kapcsolat", path:"/kapcsolat", cards:[ {id:uid(),key:"kapcsolat-form",title:"kapcsolat form"}, {id:uid(),key:"kapcsolat-map",title:"kapcsolat map"} ]},
          { id:uid(), title:"Referenci√°k", path:"/referenciak", cards:[ {id:uid(),key:"referenciak",title:"referenci√°k"}, {id:uid(),key:"top-termekek",title:"top term√©kek"}, {id:uid(),key:"top-beszallitok",title:"top besz√°ll√≠t√≥k"} ]}
        ]
      };
      let loaded=null;

      // 1) Firestore az els≈ëdleges
      if(firebaseEnabled && dbFirestore){
        try{
          const fsSnap = await getDoc(doc(dbFirestore,"settings","layoutBoards"));
          if(fsSnap.exists()) loaded = fsSnap.data() || null;
        }catch(e){
          console.warn("[layoutBoards] Firestore bet√∂lt√©si hiba:", e);
        }
      }

      // 2) Ha Firestore √ºres, fallback RTDB-re (migr√°ci√≥ el≈ëtti √°llapothoz)
      if(!loaded && firebaseEnabled && dbRealtime){
        try{
          const snap = await get(dbRef(dbRealtime,"settings/layoutBoards"));
          if(snap.exists()) loaded = snap.val() || null;
        }catch(e){
          console.warn("[layoutBoards] RTDB bet√∂lt√©si hiba:", e);
        }
      }

      board = (loaded && loaded.lists) ? loaded : seed;
      renderBoard();
    }
    document.getElementById("addListBtn").addEventListener("click", ()=>{ board.lists.push({id:uid(),title:"√öj lista",path:"/",cards:[]}); renderBoard(); autoSave(); });
    document.getElementById("layoutSaveBtnBoards").addEventListener("click", saveBoard);

    /* ---------- Email be√°ll√≠t√°s (Firestore) ---------- */
    const emailForm = document.getElementById("emailForm");
    const emailRecipient = document.getElementById("emailRecipient");
    const emailStatus = document.getElementById("emailStatus");

    async function loadEmail(){
      if(!emailRecipient) return;

      let data = null;

      // Firestore az els≈ëdleges
      if (firebaseEnabled && dbFirestore) {
        try {
          const s = await getDoc(doc(dbFirestore, "settings", "email"));
          if (s.exists()) data = s.data() || null;
        } catch (e) {
          console.warn("[email] Firestore bet√∂lt√©si hiba:", e);
        }
      }

      // fallback RTDB (migr√°ci√≥ el≈ëtt)
      if (!data && firebaseEnabled && dbRealtime) {
        try {
          const snap = await get(dbRef(dbRealtime,"settings/email"));
          if (snap.exists()) data = snap.val() || null;
        } catch (e) {}
      }

      emailRecipient.value = (data?.recipient) ? String(data.recipient) : "";
    }

    emailForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const recipient = (emailRecipient?.value || "").trim();

      if(firebaseEnabled && dbFirestore){
        await setDoc(doc(dbFirestore,"settings","email"), { recipient, updatedAt: Date.now() }, { merge:true });

        if (WRITE_RTD_BK && dbRealtime) {
          await set(dbRef(dbRealtime,"settings/email"), { recipient, updatedAt: Date.now() });
        }
      }

      if(emailStatus){
        emailStatus.textContent="Mentve ‚úÖ";
        setTimeout(()=>emailStatus.textContent="",1500);
      }
    });

/* ---------- Tartalom szerkeszt≈ëk ---------- */
    const contentFormsWrap = document.getElementById("contentForms");

    // Itt adjuk meg, hogy szekci√≥nk√©nt milyen mez≈ëket tud be√°ll√≠tani az admin.
    // name = kulcs a DB-ben, label = felirat az admin fel√ºleten.
    const SECTION_FIELDS = {
      site: {
        title: "Glob√°lis be√°ll√≠t√°sok (fejl√©c, l√°bl√©c, el√©rhet≈ës√©gek)",
        fields: [
          { name: "brandMain",        label: "Fejl√©c ‚Äì c√©gn√©v (pl. Mesz-Tor Kft.)" },
          { name: "brandSub",         label: "Fejl√©c ‚Äì alc√≠m (pl. Kaputechnikai szak√ºzlet)" },

          { name: "topbarPhones",     label: "Topbar ‚Äì telefonsz√°m(ok)" },
          { name: "topbarEmail",      label: "Topbar ‚Äì e-mail c√≠m" },
          { name: "topbarAddress",    label: "Topbar ‚Äì c√≠m (pl. Sz√©kesfeh√©rv√°r √©s k√∂rny√©ke)" },
          { name: "topbarCtaText",    label: "Topbar ‚Äì CTA gomb sz√∂vege (pl. Aj√°nlatot k√©rek)" },

          { name: "navHome",          label: "Men√º ‚Äì ‚ÄûKezd≈ëlap‚Äù felirat" },
          { name: "navProducts",      label: "Men√º ‚Äì ‚ÄûTerm√©kv√°laszt√©k‚Äù felirat" },
          { name: "navServices",      label: "Men√º ‚Äì ‚ÄûSzolg√°ltat√°sok‚Äù felirat" },
          { name: "navWhyUs",         label: "Men√º ‚Äì ‚ÄûMi√©rt mi?‚Äù felirat" },
          { name: "navReferences",    label: "Men√º ‚Äì ‚ÄûReferenci√°k‚Äù felirat" },
          { name: "navContact",       label: "Men√º ‚Äì ‚ÄûKapcsolat‚Äù felirat" },
          { name: "navCtaText",       label: "Men√º ‚Äì kiemelt gomb sz√∂veg (pl. Aj√°nlatk√©r√©s)" },

          { name: "footerText",       label: "L√°bl√©c ‚Äì f≈ë sz√∂veg" },
          { name: "footerLink1Label", label: "L√°bl√©c ‚Äì 1. link sz√∂veg" },
          { name: "footerLink1Href",  label: "L√°bl√©c ‚Äì 1. link URL" },
          { name: "footerLink2Label", label: "L√°bl√©c ‚Äì 2. link sz√∂veg" },
          { name: "footerLink2Href",  label: "L√°bl√©c ‚Äì 2. link URL" },
          { name: "footerLink3Label", label: "L√°bl√©c ‚Äì 3. link sz√∂veg" },
          { name: "footerLink3Href",  label: "L√°bl√©c ‚Äì 3. link URL" }
        ],
        image: false
      },

      hero: {
        title: "Hero szekci√≥ (nyit√≥ blokk)",
        fields: [
          { name: "kicker",             label: "Kis c√≠mke (pl. Kaputechnikai szak√ºzlet)" },
          { name: "title",              label: "F≈ë c√≠m (H1, pl. Mesz-Tor Kft.)" },
          { name: "lead",               label: "Bevezet≈ë sz√∂veg (1‚Äì2 mondat)" },

          { name: "primaryCta",         label: "Els≈ëdleges gomb sz√∂vege (pl. Aj√°nlatot k√©rek)" },
          { name: "primaryCtaTarget",   label: "Els≈ëdleges gomb c√©l (#anchor vagy URL)" },
          { name: "secondaryCta",       label: "M√°sodlagos gomb sz√∂vege" },
          { name: "secondaryCtaTarget", label: "M√°sodlagos gomb c√©l (#anchor vagy URL)" },

          { name: "meta1",              label: "Als√≥ meta sor 1 (pl. 10+ √©v tapasztalat)" },
          { name: "meta2",              label: "Als√≥ meta sor 2 (pl. Gyors kisz√°ll√°s, megb√≠zhat√≥ min≈ës√©g)" }
        ],
        image: true   // hero k√©p felt√∂lt√©se
      },

      "miert-mi": {
        title: "Mi√©rt mi? (el≈ëny√∂k blokk)",
        fields: [
          { name: "sectionKicker", label: "Szekci√≥ kis c√≠mke (pl. Mi√©rt v√°lassz minket?)" },
          { name: "sectionTitle",  label: "Szekci√≥ c√≠me" },
          { name: "sectionLead",   label: "Szekci√≥ le√≠r√°s / mott√≥" },

          { name: "card1Title",    label: "1. k√°rtya c√≠m" },
          { name: "card1Text",     label: "1. k√°rtya sz√∂veg" },
          { name: "card2Title",    label: "2. k√°rtya c√≠m" },
          { name: "card2Text",     label: "2. k√°rtya sz√∂veg" },
          { name: "card3Title",    label: "3. k√°rtya c√≠m" },
          { name: "card3Text",     label: "3. k√°rtya sz√∂veg" }
        ],
        image: false
      },

      szolgaltatasok: {
        title: "Szolg√°ltat√°sok (folyamat l√©p√©sek)",
        fields: [
          { name: "sectionKicker", label: "Szekci√≥ kis c√≠mke (pl. Szolg√°ltat√°saink)" },
          { name: "sectionTitle",  label: "Szekci√≥ c√≠me" },
          { name: "sectionLead",   label: "Szekci√≥ le√≠r√°s" },

          { name: "step1Title",    label: "1. l√©p√©s c√≠m (pl. Felm√©r√©s)" },
          { name: "step1Text",     label: "1. l√©p√©s sz√∂veg" },
          { name: "step2Title",    label: "2. l√©p√©s c√≠m" },
          { name: "step2Text",     label: "2. l√©p√©s sz√∂veg" },
          { name: "step3Title",    label: "3. l√©p√©s c√≠m" },
          { name: "step3Text",     label: "3. l√©p√©s sz√∂veg" },
          { name: "step4Title",    label: "4. l√©p√©s c√≠m" },
          { name: "step4Text",     label: "4. l√©p√©s sz√∂veg" },
          { name: "step5Title",    label: "5. l√©p√©s c√≠m" },
          { name: "step5Text",     label: "5. l√©p√©s sz√∂veg" }
        ],
        image: false
      },

      projects: {
        title: "Mott√≥ / projektek blokk",
        fields: [
          { name: "mottoTitle", label: "Mott√≥ blokk c√≠me" },
          { name: "mottoText",  label: "Mott√≥ sz√∂veg" },
          { name: "ctaText",    label: "Aj√°nlatk√©r√©s blokk sz√∂veg" },
          { name: "ctaButton",  label: "Aj√°nlatk√©r√©s gomb felirata" }
        ],
        image: false
      },

      referenciak: {
        title: "Referenci√°k szekci√≥",
        fields: [
          { name: "sectionKicker", label: "Szekci√≥ kis c√≠mke" },
          { name: "sectionTitle",  label: "Szekci√≥ c√≠me (pl. Referenci√°ink)" },
          { name: "sectionLead",   label: "Szekci√≥ le√≠r√°s" },
          { name: "emptyText",     label: "√úres √°llapot sz√∂veg (ha nincs referencia)" }
        ],
        image: false
      },

      "kapcsolat-form": {
        title: "Kapcsolat ‚Äì bal oldali blokk / ≈±rlap sz√∂vegek",
        fields: [
          { name: "sectionKicker", label: "Szekci√≥ kis c√≠mke" },
          { name: "sectionTitle",  label: "Szekci√≥ c√≠me (pl. Kapcsolat)" },
          { name: "sectionLead",   label: "Szekci√≥ le√≠r√°s (1‚Äì2 mondat)" },

          { name: "leftIntro",     label: "Bal oldali k√°rtya f≈ë sz√∂veg" },
          { name: "ctaButton",     label: "Aj√°nlatk√©r√©s gomb felirata" },
          { name: "leftTip",       label: "Bal oldali k√°rtya kis tipp / megjegyz√©s" }
        ],
        image: false
      },

      "kapcsolat-map": {
        title: "Kapcsolat ‚Äì el√©rhet≈ës√©gek + t√©rk√©p",
        fields: [
          { name: "phoneLabel",    label: "Telefon c√≠msor" },
          { name: "phoneLine1",    label: "Telefon ‚Äì 1. sor" },
          { name: "phoneLine2",    label: "Telefon ‚Äì 2. sor" },

          { name: "emailLabel",    label: "E-mail c√≠msor" },
          { name: "emailAddress",  label: "E-mail c√≠m" },

          { name: "addressLabel",  label: "C√≠m c√≠msor (pl. Bemutat√≥terem)" },
          { name: "addressLine",   label: "C√≠m sz√∂veg" },
          { name: "openingHours",  label: "Nyitvatart√°s sz√∂veg" },

          { name: "facebookLabel", label: "Facebook c√≠msor" },
          { name: "facebookHandle",label: "Facebook oldal / URL" },

          { name: "mapEmbedSrc",   label: "Google Maps iframe SRC (be√°gyazott t√©rk√©p linkje)" }
        ],
        image: false
      },

      footer: {
        title: "L√°bl√©c (ha k√ºl√∂n akarsz m√©g be√°ll√≠tani)",
        fields: [
          { name: "text",         label: "F≈ë sz√∂veg" },
          { name: "link1Label",   label: "1. link sz√∂veg" },
          { name: "link1Href",    label: "1. link URL" },
          { name: "link2Label",   label: "2. link sz√∂veg" },
          { name: "link2Href",    label: "2. link URL" },
          { name: "link3Label",   label: "3. link sz√∂veg" },
          { name: "link3Href",    label: "3. link URL" }
        ],
        image: false
      },

      "top-termekek": {
        title: "Term√©kv√°laszt√©k blokk (opcion√°lis)",
        fields: [
          { name: "sectionKicker", label: "Szekci√≥ kis c√≠mke" },
          { name: "sectionTitle",  label: "Szekci√≥ c√≠me" },
          { name: "sectionLead",   label: "Szekci√≥ le√≠r√°s" }
        ],
        image: false
      },

      "top-beszallitok": {
        title: "Top besz√°ll√≠t√≥k blokk (opcion√°lis)",
        fields: [
          { name: "sectionTitle",  label: "Blokk c√≠me" },
          { name: "sectionLead",   label: "Blokk le√≠r√°s" }
        ],
        image: false
      }
    };

    // Egyszer≈±s√≠t≈ë helper: string -> {name,label}
    function normalizeFieldsArray(fields) {
      return (fields || []).map(f => {
        if (typeof f === "string") {
          return { name: f, label: f };
        }
        return f;
      });
    }

    function sectionFormTemplate(key, data){
      const metaBase = SECTION_FIELDS[key] || { title:key, fields:[], image:false };
      const meta = { ...metaBase, fields: normalizeFieldsArray(metaBase.fields) };

      const fieldsHtml = (meta.fields || []).map(f => {
        const value = data && data[f.name]
          ? String(data[f.name]).replace(/"/g,'&quot;')
          : "";
        return `
        <label style="display:block;margin:.35rem 0">
          <div style="font-size:.8rem;margin-bottom:.1rem">${f.label}</div>
          <input type="text" data-field="${f.name}" value="${value}" />
        </label>`;
      }).join("");

      const imgHtml = meta.image ? `
        <label style="display:block;margin:.45rem 0">K√©p (opcion√°lis)
          <input type="file" accept="image/*" data-img />
        </label>
        <div class="muted preview">${(data && data.imageDataUrl) ? 'Jelenleg van k√©p' : 'Nincs k√©p felt√∂ltve'}</div>` : "";

      return `
        <div class="kpi panel" style="padding:14px" data-key="${key}">
          <div style="font-weight:700;margin-bottom:.25rem">
            ${meta.title} <span class="muted">(${key})</span>
          </div>
          ${fieldsHtml}
          ${imgHtml}
          <div style="margin-top:.5rem">
            <button class="btn primary" data-save>Ment√©s</button>
            <span class="muted" data-status></span>
          </div>
        </div>`;
    }

    function getSectionKeys(){
      const set = new Set();

      // Layout-b√≥l j√∂v≈ë szekci√≥k
      if (board?.lists?.length) {
        board.lists.forEach(list => {
          (list.cards || []).forEach(c => {
            const k = c.key || slug(c.title);
            if (k) set.add(k);
          });
        });
      }

      // El≈ëre defini√°lt szekci√≥-kulcsok (pl. 'site')
      Object.keys(SECTION_FIELDS).forEach(k => set.add(k));

      return [...set];
    }

    async function loadContent(){

      if (!contentFormsWrap) return; 

      const order = getSectionKeys();
      let all = {};

      // 1) Firestore az els≈ëdleges
      if (firebaseEnabled && dbFirestore) {
        try{
          const snap = await getDocs(collection(dbFirestore, "contentSections"));
          if (!snap.empty) {
            snap.forEach(d => { all[d.id] = d.data() || {}; });
          }
        }catch(e){
          console.warn("[content] Firestore bet√∂lt√©si hiba:", e);
        }
      }

      // 2) fallback RTDB (migr√°ci√≥ el≈ëtt)
      if (Object.keys(all).length === 0 && firebaseEnabled && dbRealtime) {
        try{
          const snap = await get(dbRef(dbRealtime,"content/sections"));
          all = snap.exists() ? (snap.val() || {}) : {};
        }catch(e){}
      }

      contentFormsWrap.innerHTML = order
        .map(k => sectionFormTemplate(k, all[k]))
        .join("");

      contentFormsWrap.querySelectorAll("[data-key]").forEach(card => {
        const key = card.dataset.key;
        let imageDataUrl = all[key]?.imageDataUrl || null;

        const imgInput = card.querySelector('input[type=file][data-img]');
        if (imgInput) {
          imgInput.addEventListener("change", async ()=>{
            const f = imgInput.files?.[0]; 
            if (!f) return;

            try{
              imageDataUrl = await fileToOptimizedDataUrl(f, { maxW: 1400, maxH: 1400, quality: 0.78 });
              const prev = card.querySelector(".preview");
              if (prev) prev.textContent = "K√©p kiv√°lasztva (ment√©s ut√°n el√©rhet≈ë).";
            }catch(err){
              console.warn("[content] k√©p hiba:", err);
              alert(err?.message || "Nem siker√ºlt a k√©pet feldolgozni.");
            }
          });
        }

        card.querySelector("[data-save]").addEventListener("click", async (e)=>{
          e.preventDefault();

          const fields = {};
          card.querySelectorAll('input[type=text][data-field]').forEach(inp => {
            fields[inp.dataset.field] = inp.value.trim();
          });

          const payload = { ...fields, updatedAt: Date.now() };
          if (imageDataUrl) payload.imageDataUrl = imageDataUrl;

          if (firebaseEnabled && dbFirestore) {
            await setDoc(doc(dbFirestore, "contentSections", key), payload, { merge:true });

            if (WRITE_RTD_BK && dbRealtime) {
              await set(dbRef(dbRealtime, `content/sections/${key}`), payload);
            }
          }

          const st = card.querySelector("[data-status]");
          if (st) {
            st.textContent = "Mentve ‚úÖ";
            setTimeout(()=> st.textContent = "", 1500);
          }
        });
      });
    }

        /* ---------- Besz√°ll√≠t√≥ partnerek admin (Firestore) ---------- */
    const supplierForm = document.getElementById("supplierForm");
    const supplierNameInput = document.getElementById("supplierName");
    const supplierSubtitleInput = document.getElementById("supplierSubtitle");
    const supplierImageInput = document.getElementById("supplierImage");
    const supplierStatusEl = document.getElementById("supplierStatus");
    const suppliersListEl = document.getElementById("suppliersList");

    async function loadSuppliersAdmin() {
      if (!suppliersListEl) return;

      if (!firebaseEnabled || !dbFirestore) {
        suppliersListEl.innerHTML =
          '<div class="muted">Demo m√≥d ‚Äì a besz√°ll√≠t√≥k nem ker√ºlnek ment√©sre.</div>';
        return;
      }

      suppliersListEl.innerHTML = '<div class="muted">Bet√∂lt√©s...</div>';

      try {
        const items = await fsListAll("suppliers");

        if (!items.length) {
          suppliersListEl.innerHTML =
            '<div class="muted">M√©g nincs r√∂gz√≠tett besz√°ll√≠t√≥ partner.</div>';
          return;
        }

        // Rendez√©s: orderIndex (n√∂vekv≈ë), majd createdAt (cs√∂kken≈ë)
        items.sort((a, b) => {
          const ai = (a.orderIndex ?? 999999999999);
          const bi = (b.orderIndex ?? 999999999999);
          if (ai !== bi) return ai - bi;
          return (b.createdAt || 0) - (a.createdAt || 0);
        });

        const pendingImages = new Map();

        suppliersListEl.innerHTML = items
          .map((item) => {
            const imgSrc = item.imageUrl || item.imageDataUrl || "";
            const name = (item.name || "").replace(/"/g, "&quot;");
            const subtitle = (item.subtitle || "").replace(/"/g, "&quot;");

            return `
              <div class="kpi panel"
                   style="padding:10px; display:flex; gap:10px; align-items:center; margin-top:10px;"
                   data-supplier-id="${item.id}">
                <div style="width:80px; flex-shrink:0;">
                  ${
                    imgSrc
                      ? `<img src="${imgSrc}" alt="Besz√°ll√≠t√≥ log√≥"
                               style="width:100%;height:60px;object-fit:cover;border-radius:10px;border:1px solid rgba(15,23,42,.08);" />`
                      : `<div class="muted" style="font-size:.8rem;">Nincs k√©p</div>`
                  }
                  <div style="margin-top:25px;">
                    <input type="file" accept="image/*" data-supplier-image
                           style="display:inline-block;margin-left:0;" />
                  </div>
                </div>

                <div style="flex:1 1 auto;min-width:0;">
                  <input type="text"
                         data-supplier-name
                         value="${name}"
                         style="width:100%;padding:.4rem .5rem;border-radius:8px;border:1px solid #e5e7eb;margin-bottom:4px;" />
                  <input type="text"
                         data-supplier-subtitle
                         value="${subtitle}"
                         placeholder="Alc√≠m (opcion√°lis)"
                         style="width:100%;padding:.35rem .5rem;border-radius:8px;border:1px solid #e5e7eb;font-size:.8rem;" />
                  <div class="muted" style="font-size:.75rem;margin-top:4px;">
                  </div>
                </div>

                <div style="flex-shrink:0;display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
                  <button class="btn primary" style="" data-supplier-save>Ment√©s</button>
                  <button class="btn primary" style="background: #CC4223; color: white;border: none;" data-supplier-delete>T√∂rl√©s</button>
                </div>
              </div>
            `;
          })
          .join("");

        // K√©p csere -> pendingImages (t√∂m√∂r√≠tve)
        suppliersListEl.querySelectorAll("[data-supplier-image]").forEach((input) => {
          input.addEventListener("change", async () => {
            const wrap = input.closest("[data-supplier-id]");
            const id = wrap?.dataset?.supplierId;
            const f = input.files?.[0];
            if (!id || !f) return;

            try{
              const dataUrl = await fileToOptimizedDataUrl(f, { maxW: 700, maxH: 700, quality: 0.78 });
              pendingImages.set(id, dataUrl);
              supplierStatusEl.textContent = "K√©p kiv√°lasztva (ment√©s ut√°n friss√ºl).";
              setTimeout(()=> supplierStatusEl.textContent="", 1500);
            }catch(err){
              console.warn("[suppliersAdmin] k√©p hiba:", err);
              alert(err?.message || "Nem siker√ºlt a k√©pet feldolgozni.");
            }
          });
        });

        // Ment√©s gomb (n√©v/alc√≠m/k√©p)
        suppliersListEl.querySelectorAll("[data-supplier-save]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const wrap = btn.closest("[data-supplier-id]");
            if (!wrap) return;

            const id = wrap.dataset.supplierId;
            const nameInput = wrap.querySelector("[data-supplier-name]");
            const subtitleInput = wrap.querySelector("[data-supplier-subtitle]");

            const name = nameInput?.value?.trim() || "";
            const subtitle = subtitleInput?.value?.trim() || "";

            try{
              const base = await getDoc(doc(dbFirestore, "suppliers", id));
              if(!base.exists()) return;

              const current = base.data() || {};
              const payload = {
                ...current,
                name,
                subtitle,
                updatedAt: Date.now()
              };

              if (pendingImages.has(id)) {
                payload.imageDataUrl = pendingImages.get(id); 
                delete payload.imageUrl;
              }

              await setDoc(doc(dbFirestore, "suppliers", id), payload, { merge:false });

              if (WRITE_RTD_BK && dbRealtime) {
                await set(dbRef(dbRealtime, "suppliers/" + id), payload);
              }

              await loadSuppliersAdmin();
              supplierStatusEl.textContent = "Mentve ‚úÖ";
            }catch(err){
              console.warn("[suppliersAdmin] ment√©s hiba:", err);
              supplierStatusEl.textContent = "Hiba ment√©s k√∂zben.";
            }finally{
              setTimeout(() => { if (supplierStatusEl) supplierStatusEl.textContent = ""; }, 2000);
            }
          });
        });

        // T√∂rl√©s
        suppliersListEl.querySelectorAll("[data-supplier-delete]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const wrap = btn.closest("[data-supplier-id]");
            const id = wrap?.dataset?.supplierId;
            if (!id) return;
            if (!confirm("Biztosan t√∂rl√∂d ezt a besz√°ll√≠t√≥t?")) return;

            try{
              await deleteDoc(doc(dbFirestore, "suppliers", id));
              if (WRITE_RTD_BK && dbRealtime) {
                await remove(dbRef(dbRealtime, "suppliers/" + id));
              }
              await loadSuppliersAdmin();
              supplierStatusEl.textContent = "T√∂r√∂lve ‚úÖ";
            }catch(err){
              console.warn("[suppliersAdmin] t√∂rl√©s hiba:", err);
              supplierStatusEl.textContent = "Hiba t√∂rl√©s k√∂zben.";
            }finally{
              setTimeout(() => { if (supplierStatusEl) supplierStatusEl.textContent = ""; }, 2000);
            }
          });
        });

      } catch (err) {
        console.warn("[suppliersAdmin] bet√∂lt√©s hiba:", err);
        suppliersListEl.innerHTML =
          '<div class="muted">Hiba a besz√°ll√≠t√≥k bet√∂lt√©sekor.</div>';
      }
    }

    supplierForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!firebaseEnabled || !dbFirestore) return;

      const name = supplierNameInput?.value?.trim() || "";
      const subtitle = supplierSubtitleInput?.value?.trim() || "";
      const file = supplierImageInput?.files?.[0];

      if (!name) {
        alert("Add meg a besz√°ll√≠t√≥ nev√©t.");
        return;
      }

      if (!file) {
        alert("V√°lassz egy log√≥t.");
        return;
      }

      supplierStatusEl.textContent = "Feldolgoz√°s...";

      try {
        const dataUrl = await fileToOptimizedDataUrl(file, { maxW: 700, maxH: 700, quality: 0.78 });

        const id = doc(collection(dbFirestore, "suppliers")).id;

        const payload = {
          name,
          subtitle,
          imageDataUrl: dataUrl,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          orderIndex: Date.now()
        };

        await setDoc(doc(dbFirestore, "suppliers", id), payload);

        if (WRITE_RTD_BK && dbRealtime) {
          await set(dbRef(dbRealtime, "suppliers/" + id), payload);
        }

        supplierForm.reset();
        supplierStatusEl.textContent = "Mentve ‚úÖ";
        await loadSuppliersAdmin();
      } catch (err) {
        console.warn("[suppliersAdmin] ment√©s hiba:", err);
        supplierStatusEl.textContent = "Hiba ment√©s k√∂zben.";
      } finally {
        setTimeout(() => {
          if (supplierStatusEl) supplierStatusEl.textContent = "";
        }, 2000);
      }
    });


/* ---------- Referencia fot√≥k admin (Firestore) ---------- */
    const referencesForm = document.getElementById("referencesForm");
    const referencesStatusEl = document.getElementById("referencesStatus");
    const referencesListEl = document.getElementById("referencesList");
    const refTitleInput = document.getElementById("refTitle");
    const refDescInput = document.getElementById("refDesc");
    const refImageInput = document.getElementById("refImage");

    async function loadReferencesAdmin(){
      if (!referencesListEl) return;

      if (!firebaseEnabled || !dbFirestore) {
        referencesListEl.innerHTML = '<div class="muted">Demo m√≥d ‚Äì a referenci√°k nem ker√ºlnek ment√©sre.</div>';
        return;
      }

      referencesListEl.innerHTML = '<div class="muted">Bet√∂lt√©s...</div>';

      try{
        const items = await fsListAll("references");

        if (!items.length) {
          referencesListEl.innerHTML = '<div class="muted">M√©g nincs felt√∂lt√∂tt referencia.</div>';
          return;
        }

        items.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

        referencesListEl.innerHTML = items.map(item => {
          const imgSrc = item.imageUrl || item.imageDataUrl || "";
          const title = (item.title || "").replace(/</g,"&lt;");
          const desc  = (item.desc  || "").replace(/</g,"&lt;");

          return `
            <div class="kpi panel" style="padding:10px; display:flex; gap:10px; align-items:center; margin-top:10px;"
                 data-ref-id="${item.id}">
              <div style="width:80px; flex-shrink:0;">
                ${imgSrc ? `<img src="${imgSrc}" alt="Referencia" style="width:100%;height:60px;object-fit:cover;border-radius:10px;border:1px solid rgba(15,23,42,.08);" />`
                        : `<div class="muted" style="font-size:.8rem;">Nincs k√©p</div>`}
              </div>

              <div style="flex:1 1 auto;min-width:0;">
                <div style="font-weight:700;">${title || "(c√≠m n√©lk√ºl)"}</div>
                <div class="muted" style="font-size:.85rem;">${desc || ""}</div>
                <div class="muted" style="font-size:.75rem;margin-top:4px;">ID: ${item.id}</div>
              </div>

              <div style="flex-shrink:0; display:flex; gap:8px; align-items:center;">
                <button class="btn ghost" data-ref-delete>T√∂rl√©s</button>
              </div>
            </div>
          `;
        }).join("");

        referencesListEl.querySelectorAll("[data-ref-delete]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const wrap = btn.closest("[data-ref-id]");
            const id = wrap?.dataset?.refId;
            if (!id) return;
            if (!confirm("Biztosan t√∂rl√∂d ezt a referenci√°t?")) return;

            try{
              await deleteDoc(doc(dbFirestore, "references", id));
              if (WRITE_RTD_BK && dbRealtime) {
                await remove(dbRef(dbRealtime, "references/" + id));
              }
              await loadReferencesAdmin();
            }catch(err){
              console.warn("[referencesAdmin] t√∂rl√©s hiba:", err);
              alert("Nem siker√ºlt t√∂r√∂lni.");
            }
          });
        });

      }catch(err){
        console.warn("[referencesAdmin] bet√∂lt√©s hiba:", err);
        referencesListEl.innerHTML = '<div class="muted">Hiba a referenci√°k bet√∂lt√©sekor.</div>';
      }
    }

    referencesForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();

      if (!firebaseEnabled || !dbFirestore) return;

      const title = refTitleInput?.value?.trim() || "";
      const desc  = refDescInput?.value?.trim() || "";
      const file  = refImageInput?.files?.[0];

      if (!file) { alert("V√°lassz egy k√©pet."); return; }

      referencesStatusEl.textContent = "Feldolgoz√°s...";

      try{
        const dataUrl = await fileToOptimizedDataUrl(file, { maxW: 1600, maxH: 1600, quality: 0.78 });

        const id = doc(collection(dbFirestore, "references")).id;
        const payload = {
          title,
          desc,
          imageDataUrl: dataUrl,
          createdAt: Date.now(),
          updatedAt: Date.now()
        };

        await setDoc(doc(dbFirestore, "references", id), payload);

        if (WRITE_RTD_BK && dbRealtime) {
          await set(dbRef(dbRealtime, "references/" + id), payload);
        }

        referencesForm.reset();
        referencesStatusEl.textContent = "Mentve ‚úÖ";
        await loadReferencesAdmin();
      }catch(err){
        console.warn("[referencesAdmin] ment√©s hiba:", err);
        referencesStatusEl.textContent = "Hiba ment√©s k√∂zben.";
      }finally{
        setTimeout(()=>{ if(referencesStatusEl) referencesStatusEl.textContent=""; }, 2000);
      }
    });


/* ---------- Term√©kek admin (Firestore) ---------- */

    const productForm       = document.getElementById("productForm");
    const productNameInput  = document.getElementById("productName");
    const productShortInput = document.getElementById("productShort");
    const productLongInput  = document.getElementById("productLong");
    const productImageInput = document.getElementById("productImage");
    const productStatusEl   = document.getElementById("productStatus");
    const productsListEl    = document.getElementById("productsList");

    async function loadProductsAdmin() {
      if (!productsListEl) return;

      if (!firebaseEnabled || !dbFirestore) {
        productsListEl.innerHTML =
          '<div class="muted">Demo m√≥d ‚Äì a term√©kek nem ker√ºlnek ment√©sre.</div>';
        return;
      }

      productsListEl.innerHTML = '<div class="muted">Bet√∂lt√©s...</div>';

      try {
        const items = await fsListAll("products");

        if (!items.length) {
          productsListEl.innerHTML =
            '<div class="muted">M√©g nincs felt√∂lt√∂tt term√©k.</div>';
          return;
        }

        items.sort((a,b)=> (b.createdAt || 0) - (a.createdAt || 0));

        productsListEl.innerHTML = items.map(item => {
          const imgSrc = item.imageUrl || item.imageDataUrl || "";
          const name = (item.name || "").replace(/</g,"&lt;");
          const short = (item.short || "").replace(/</g,"&lt;");

          return `
            <div class="kpi panel" style="padding:10px; display:flex; gap:10px; align-items:center; margin-top:10px;"
                 data-product-id="${item.id}">
              <div style="width:80px; flex-shrink:0;">
                ${imgSrc ? `<img src="${imgSrc}" alt="Term√©k" style="width:100%;height:60px;object-fit:cover;border-radius:10px;border:1px solid rgba(15,23,42,.08);" />`
                        : `<div class="muted" style="font-size:.8rem;">Nincs k√©p</div>`}
              </div>

              <div style="flex:1 1 auto;min-width:0;">
                <div style="font-weight:700;">${name || "(n√©v n√©lk√ºl)"}</div>
                <div class="muted" style="font-size:.85rem;">${short || ""}</div>
                <div class="muted" style="font-size:.75rem;margin-top:4px;">ID: ${item.id}</div>
              </div>

              <div style="flex-shrink:0; display:flex; gap:8px; align-items:center;">
                <button class="btn ghost" data-product-delete>T√∂rl√©s</button>
              </div>
            </div>
          `;
        }).join("");

        productsListEl.querySelectorAll("[data-product-delete]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const wrap = btn.closest("[data-product-id]");
            const id = wrap?.dataset?.productId;
            if (!id) return;
            if (!confirm("Biztosan t√∂rl√∂d ezt a term√©ket?")) return;

            try{
              await deleteDoc(doc(dbFirestore, "products", id));
              if (WRITE_RTD_BK && dbRealtime) {
                await remove(dbRef(dbRealtime, "products/" + id));
              }
              await loadProductsAdmin();
            }catch(err){
              console.warn("[productsAdmin] t√∂rl√©s hiba:", err);
              alert("Nem siker√ºlt t√∂r√∂lni.");
            }
          });
        });

      } catch (err) {
        console.warn("[productsAdmin] bet√∂lt√©s hiba:", err);
        productsListEl.innerHTML =
          '<div class="muted">Hiba a term√©kek bet√∂lt√©sekor.</div>';
      }
    }

    productForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!firebaseEnabled || !dbFirestore) return;

      const name  = productNameInput?.value?.trim() || "";
      const short = productShortInput?.value?.trim() || "";
      const long  = productLongInput?.value?.trim() || "";
      const file  = productImageInput?.files?.[0];

      if (!name) { alert("Add meg a term√©k nev√©t."); return; }
      if (!file) { alert("V√°lassz egy k√©pet."); return; }

      productStatusEl.textContent = "Feldolgoz√°s...";

      try {
        const dataUrl = await fileToOptimizedDataUrl(file, { maxW: 1600, maxH: 1600, quality: 0.78 });

        const id = doc(collection(dbFirestore, "products")).id;

        const payload = {
          name,
          short,
          long,
          imageDataUrl: dataUrl,
          createdAt: Date.now(),
          updatedAt: Date.now()
        };

        await setDoc(doc(dbFirestore, "products", id), payload);

        if (WRITE_RTD_BK && dbRealtime) {
          await set(dbRef(dbRealtime, "products/" + id), payload);
        }

        productForm.reset();
        productStatusEl.textContent = "Mentve ‚úÖ";
        await loadProductsAdmin();
      } catch (err) {
        console.warn("[productsAdmin] ment√©s hiba:", err);
        productStatusEl.textContent = "Hiba ment√©s k√∂zben.";
      } finally {
        setTimeout(() => { if (productStatusEl) productStatusEl.textContent = ""; }, 2000);
      }
    });


/* ---------- F≈ëoldali slider admin (Firestore) ---------- */
    const sliderForm = document.getElementById("sliderForm");
    const sliderTitleInput = document.getElementById("sliderTitle");
    const sliderSubtitleInput = document.getElementById("sliderSubtitle");
    const sliderImageInput = document.getElementById("sliderImage");
    const sliderStatusEl = document.getElementById("sliderStatus");
    const sliderListEl = document.getElementById("sliderList");
    const sliderSaveOrderBtn = document.getElementById("sliderSaveOrderBtn");
    let sliderMaxOrder = 0;

    async function loadSliderAdmin() {
      if (!sliderListEl) return;

      if (!firebaseEnabled || !dbFirestore) {
        sliderListEl.innerHTML =
          '<div class="muted">Demo m√≥d ‚Äì a slider k√©pek nem ker√ºlnek ment√©sre.</div>';
        return;
      }

      sliderListEl.innerHTML = '<div class="muted">Bet√∂lt√©s...</div>';

      try {
        let items = await fsListAll("heroSlider");

        // fallback RTDB, ha Firestore m√©g √ºres
        if (!items.length && firebaseEnabled && dbRealtime) {
          try{
            const snap = await get(dbRef(dbRealtime, "heroSlider"));
            if (snap.exists()) {
              const val = snap.val() || {};
              items = Object.entries(val).map(([id,d]) => ({ id, ...(d || {}) }));
            }
          }catch(e){}
        }

        if (!items.length) {
          sliderListEl.innerHTML =
            '<div class="muted">M√©g nincs felt√∂lt√∂tt slider k√©p.</div>';
          return;
        }

        items.sort((a,b) => (a.order ?? 999999) - (b.order ?? 999999));

        sliderMaxOrder = items.reduce((m,it)=>Math.max(m, (typeof it.order==="number"? it.order : -1)), -1);
        if (sliderMaxOrder < 0) sliderMaxOrder = items.length - 1;

        sliderListEl.innerHTML = items
          .map((item) => {
            const imgSrc = item.imageUrl || item.imageDataUrl || "";
            const title = (item.title || "").replace(/</g,"&lt;");
            const subtitle = (item.subtitle || "").replace(/</g,"&lt;");

            return `
              <div class="kpi panel"
                   style="padding:10px; display:flex; gap:10px; align-items:center; margin-top:10px;"
                   data-slide-id="${item.id}">
                <div class="drag-handle" title="H√∫zd a sorrendhez"
                     style="cursor:grab; user-select:none; font-size:18px; padding:0 6px; opacity:.7;">‚†ø</div>

                <div style="width:80px; flex-shrink:0;">
                  ${imgSrc ? `<img src="${imgSrc}" alt="Slider"
                               style="width:100%;height:60px;object-fit:cover;border-radius:10px;border:1px solid rgba(15,23,42,.08);" />`
                          : `<div class="muted" style="font-size:.8rem;">Nincs k√©p</div>`}
                </div>

                <div style="flex:1 1 auto;min-width:0;">
                  <div style="font-weight:700;">${title || "(c√≠m n√©lk√ºl)"}</div>
                  <div class="muted" style="font-size:.85rem;">${subtitle || ""}</div>
                  <div class="muted" style="font-size:.75rem;margin-top:4px;">ID: ${item.id}</div>
                </div>

                <div style="flex-shrink:0; display:flex; gap:8px; align-items:center;">
                  <button class="btn ghost" data-slide-delete>T√∂rl√©s</button>
                </div>
              </div>
            `;
          })
          .join("");

        // Delete
        sliderListEl.querySelectorAll("[data-slide-delete]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const wrap = btn.closest("[data-slide-id]");
            const id = wrap?.dataset?.slideId;
            if (!id) return;
            if (!confirm("Biztosan t√∂rl√∂d ezt a slider k√©pet?")) return;

            try{
              await deleteDoc(doc(dbFirestore, "heroSlider", id));
              if (WRITE_RTD_BK && dbRealtime) {
                await remove(dbRef(dbRealtime, "heroSlider/" + id));
              }
              await loadSliderAdmin();
            }catch(err){
              console.warn("[sliderAdmin] t√∂rl√©s hiba:", err);
              alert("Nem siker√ºlt t√∂r√∂lni.");
            }
          });
        });

        // Sortable
        if (window.Sortable) {
          new Sortable(sliderListEl, {
            animation: 150,
            handle: ".drag-handle",
            ghostClass: "sortable-ghost",
            onEnd: persistSliderOrder
          });
        }

      } catch (err) {
        console.warn("[sliderAdmin] bet√∂lt√©s hiba:", err);
        sliderListEl.innerHTML =
          '<div class="muted">Hiba a slider k√©pek bet√∂lt√©sekor.</div>';
      }
    }

    async function persistSliderOrder(){
      if (!firebaseEnabled || !dbFirestore) return;

      const ids = Array.from(sliderListEl.querySelectorAll("[data-slide-id]"))
        .map(el => el.getAttribute("data-slide-id"))
        .filter(Boolean);

      try{
        const batch = writeBatch(dbFirestore);
        ids.forEach((id, idx) => {
          batch.set(doc(dbFirestore, "heroSlider", id), { order: idx, updatedAt: Date.now() }, { merge:true });
        });
        await batch.commit();

        if (WRITE_RTD_BK && dbRealtime) {
          const updatesObj = {};
          ids.forEach((id, idx) => { updatesObj[`heroSlider/${id}/order`] = idx; });
          await dbUpdate(dbRef(dbRealtime, "/"), updatesObj);
        }

        if (sliderStatusEl) {
          sliderStatusEl.textContent = "Sorrend mentve ‚úÖ";
          setTimeout(() => (sliderStatusEl.textContent = ""), 1500);
        }
      }catch(err){
        console.warn("[sliderAdmin] order ment√©s hiba:", err);
        if (sliderStatusEl) sliderStatusEl.textContent = "Hiba a sorrend ment√©sn√©l.";
        setTimeout(() => (sliderStatusEl.textContent = ""), 2000);
      }
    }

    sliderSaveOrderBtn?.addEventListener("click", persistSliderOrder);

    sliderForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!firebaseEnabled || !dbFirestore) return;

      const title = sliderTitleInput?.value?.trim() || "";
      const subtitle = sliderSubtitleInput?.value?.trim() || "";
      const file = sliderImageInput?.files?.[0];

      if (!file) { alert("V√°lassz egy k√©pet."); return; }

      sliderStatusEl.textContent = "Feldolgoz√°s...";

      try{
        const dataUrl = await fileToOptimizedDataUrl(file, { maxW: 2000, maxH: 2000, quality: 0.78 });

        const id = doc(collection(dbFirestore, "heroSlider")).id;

        const payload = {
          title,
          subtitle,
          imageDataUrl: dataUrl,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          order: ++sliderMaxOrder
        };

        await setDoc(doc(dbFirestore, "heroSlider", id), payload);

        if (WRITE_RTD_BK && dbRealtime) {
          await set(dbRef(dbRealtime, "heroSlider/" + id), payload);
        }

        sliderForm.reset();
        sliderStatusEl.textContent = "Mentve ‚úÖ";
        await loadSliderAdmin();
      }catch(err){
        console.warn("[sliderAdmin] ment√©s hiba:", err);
        sliderStatusEl.textContent = "Hiba ment√©s k√∂zben.";
      }finally{
        setTimeout(()=>{ if(sliderStatusEl) sliderStatusEl.textContent=""; }, 2000);
      }
    });


/* ---------- Start ---------- */
    await loadBoard();
    await loadEmail();
    await loadContent();
    await loadAnalytics();
    await loadSuppliersAdmin();
    await loadReferencesAdmin();
    await loadProductsAdmin();
    await loadSliderAdmin();
  </script>
  

</body>
</html>